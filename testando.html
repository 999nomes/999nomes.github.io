<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App de Compras</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Bibliotecas de terceiros -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Estilo de fonte global */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Classe para esconder elementos */
    .hidden {
      display: none !important;
    }
    /* Estilo para a tabela em telas pequenas */
    .table-container {
      overflow-x: auto;
    }
    /* Estilo para o contêiner de vídeo */
    #camera-container {
      position: relative;
      width: 100%;
      padding-top: 75%; /* Proporção 4:3 */
      overflow: hidden;
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    #camera-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Navbar responsiva -->
  <nav class="bg-gray-800 p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center">
    <span class="font-bold text-xl sm:text-2xl mb-2 sm:mb-0 text-center">App de Compras</span>
    <div class="flex justify-center space-x-4">
      <button id="nav-calculator" class="py-2 px-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-colors">Calculadora</button>
      <button id="nav-shopping-list" class="py-2 px-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-colors">Lista de Compras</button>
      <button id="nav-camera" class="py-2 px-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-colors">Câmera</button>
    </div>
  </nav>

  <!-- Container principal, com padding responsivo e flexbox -->
  <main class="flex-grow p-4 sm:p-6 lg:p-8">

    <!-- Caixa de mensagens -->
    <div id="message-box" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-700 text-white p-3 rounded-lg shadow-xl z-50 transition-transform duration-300 transform scale-0 origin-bottom"></div>

    <!-- Página Calculadora -->
    <div id="calculator-page" class="page-content flex flex-col gap-6">
      <h1 class="text-2xl font-bold text-center sm:text-3xl">Calculadora de Preços</h1>
      <p class="text-center text-gray-400 max-w-2xl mx-auto">Adicione produtos para calcular o valor total de suas compras. Você pode adicionar, remover e exportar a lista para PDF.</p>

      <div class="table-container bg-gray-800 rounded-lg shadow-lg p-4">
        <table id="tabelaprod" class="w-full text-left table-auto">
          <thead class="bg-gray-700 text-gray-200 uppercase text-xs sm:text-sm">
            <tr>
              <th class="p-2 sm:p-3 rounded-tl-lg">ID</th>
              <th class="p-2 sm:p-3">Produto</th>
              <th class="p-2 sm:p-3">Preço</th>
              <th class="p-2 sm:p-3">Qtd.</th>
              <th class="p-2 sm:p-3 rounded-tr-lg">Total</th>
              <th class="p-2 sm:p-3">Ação</th>
            </tr>
          </thead>
          <tbody>
            <!-- Linhas da tabela serão inseridas aqui via JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4">
        <button id="addButton" class="flex-1 py-3 px-6 rounded-full bg-green-500 hover:bg-green-600 transition-colors shadow-md text-sm sm:text-base font-semibold">Adicionar Produto</button>
        <button id="savePDFButton" class="flex-1 py-3 px-6 rounded-full bg-red-500 hover:bg-red-600 transition-colors shadow-md text-sm sm:text-base font-semibold">Salvar PDF</button>
      </div>

      <div class="flex justify-center items-center gap-2 text-xl font-bold mt-4">
        <span>Valor Total:</span>
        <span id="totalvalue" class="text-blue-400">R$ 0.00</span>
      </div>
    </div>

    <!-- Página Lista de Compras -->
    <div id="shopping-list-page" class="page-content hidden flex flex-col gap-6">
      <h1 class="text-2xl font-bold text-center sm:text-3xl">Gerador de Lista de Compras com IA</h1>
      <p class="text-center text-gray-400 max-w-2xl mx-auto">Use a IA do Gemini para gerar uma lista de compras com base na sua necessidade, ou crie a sua própria lista manualmente.</p>

      <div class="bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col gap-4">
        <label for="gemini-prompt" class="block text-sm font-medium text-gray-200">Qual lista de compras você precisa?</label>
        <div class="flex flex-col sm:flex-row gap-4 items-end">
          <input type="text" id="gemini-prompt" placeholder="Ex: 'ingredientes para bolo de chocolate'" class="flex-grow w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button id="generate-list-button" class="py-3 px-6 rounded-full bg-purple-500 hover:bg-purple-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto">Gerar Lista com IA</button>
          <button id="instructionsButton" class="py-3 px-6 rounded-full bg-gray-500 hover:bg-gray-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto">Instruções</button>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row gap-4">
          <input type="text" id="new-product-name" placeholder="Nome do Produto" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <input type="number" id="new-product-price" placeholder="Preço (Opcional)" class="w-full sm:w-1/3 bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button id="add-product-list-button" class="py-3 px-6 rounded-full bg-green-500 hover:bg-green-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto">Adicionar</button>
        </div>
        
        <div class="table-container">
          <table id="shopping-list-table" class="w-full text-left">
            <thead class="bg-gray-700 text-gray-200 uppercase text-xs sm:text-sm">
              <tr>
                <th class="p-2 sm:p-3 rounded-tl-lg">Item</th>
                <th class="p-2 sm:p-3">Preço</th>
                <th class="p-2 sm:p-3 rounded-tr-lg">Ação</th>
              </tr>
            </thead>
            <tbody>
              <!-- Itens da lista serão inseridos aqui -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Nova Página de Câmera -->
    <div id="camera-page" class="page-content hidden flex flex-col items-center gap-6">
      <h1 class="text-2xl font-bold text-center sm:text-3xl">Identificação por Câmera</h1>
      <p class="text-center text-gray-400 max-w-2xl mx-auto">Use a câmera traseira do seu dispositivo para capturar uma imagem. A câmera só será ativada com sua permissão.</p>

      <div id="camera-container" class="w-full sm:max-w-xl">
        <video id="camera-video" class="rounded-xl shadow-lg bg-gray-800" playsinline autoplay></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
      </div>

      <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4 w-full sm:max-w-xl">
        <button id="start-camera-btn" class="py-3 px-6 rounded-full bg-green-500 hover:bg-green-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto">Ativar Câmera</button>
        <button id="capture-image-btn" class="py-3 px-6 rounded-full bg-purple-500 hover:bg-purple-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto hidden">Capturar Imagem</button>
      </div>

      <div id="captured-image-container" class="mt-8 hidden w-full sm:max-w-xl flex flex-col gap-4 items-center">
        <h2 class="text-xl font-bold">Imagem Capturada:</h2>
        <img id="captured-image" class="rounded-lg shadow-lg" alt="Imagem Capturada" />
        <button id="clear-image-btn" class="py-2 px-4 rounded-full bg-red-500 hover:bg-red-600 transition-colors shadow-md text-sm sm:text-base font-semibold">Limpar Imagem</button>
      </div>
    </div>

    <!-- Modal de API Key -->
    <div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-gray-800 text-white p-8 rounded-xl w-11/12 sm:w-96 shadow-2xl relative">
        <h2 class="text-xl font-bold mb-4 text-center">API Key do Gemini</h2>
        <p class="text-sm text-center mb-4 text-gray-400">Para usar a IA, você precisa da sua API Key.</p>
        <input type="text" id="modal-api-key-input" placeholder="Cole sua API Key aqui" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <div class="flex justify-end gap-2">
          <button id="modal-cancel-button" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
          <button id="modal-continue-button" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">Continuar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Instruções -->
    <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-gray-800 text-white p-8 rounded-xl w-11/12 sm:w-96 shadow-2xl relative">
        <h2 class="text-xl font-bold mb-4 text-center">Como obter sua API Key do Gemini</h2>
        <ol class="list-decimal ml-5 space-y-2 text-sm text-gray-300">
          <li>Acesse <a href="https://aistudio.google.com" target="_blank" class="text-blue-400 underline hover:text-blue-300 transition-colors">aistudio.google.com</a></li>
          <li>Faça login com sua conta Google.</li>
          <li>No menu lateral, clique em <b>Get API Key</b>.</li>
          <li>Clique em <b>Create API key in new project</b>.</li>
          <li>Copie a chave gerada e cole no campo acima.</li>
        </ol>
        <div class="flex justify-end mt-6">
          <button id="closeInstructions" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">Fechar</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Referência global para o objeto jsPDF
    let jsPDF;
    // Variável global para armazenar o stream da câmera
    let cameraStream = null;

    // Função para carregar dinamicamente o jsPDF
    async function loadJsPDF() {
      if (typeof window.jspdf === 'undefined') {
        const { jsPDF: jsPDFModule } = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        jsPDF = jsPDFModule;
      } else {
        jsPDF = window.jspdf.jsPDF;
      }
    }

    // Espera o DOM carregar completamente
    document.addEventListener("DOMContentLoaded", async function() {
      await loadJsPDF();

      // ----------------------------------------------------------------------------------
      // Seletores comuns
      // ----------------------------------------------------------------------------------
      const calculatorPage = document.getElementById("calculator-page");
      const tableBody = document.querySelector("#tabelaprod tbody");
      const addButton = document.getElementById("addButton");
      const savePDFButton = document.getElementById("savePDFButton");
      const totalValueSpan = document.getElementById("totalvalue");
      const calculatorLocalStorageKey = "productCalculatorData";

      const shoppingListPage = document.getElementById("shopping-list-page");
      const newProductNameInput = document.getElementById("new-product-name");
      const newProductPriceInput = document.getElementById("new-product-price");
      const addProductListButton = document.getElementById("add-product-list-button");
      const shoppingListTableBody = document.querySelector("#shopping-list-table tbody");
      const shoppingListLocalStorageKey = "shoppingListData";

      const geminiPromptInput = document.getElementById("gemini-prompt");
      const generateListButton = document.getElementById("generate-list-button");
      const apiKeyModal = document.getElementById("api-key-modal");
      const modalApiKeyInput = document.getElementById("modal-api-key-input");
      const modalContinueButton = document.getElementById("modal-continue-button");
      const modalCancelButton = document.getElementById("modal-cancel-button");
      const instructionsButton = document.getElementById("instructionsButton");
      const instructionsModal = document.getElementById("instructions-modal");
      const closeInstructions = document.getElementById("closeInstructions");

      const cameraPage = document.getElementById("camera-page");
      const cameraVideo = document.getElementById("camera-video");
      const cameraCanvas = document.getElementById("camera-canvas");
      const startCameraBtn = document.getElementById("start-camera-btn");
      const captureImageBtn = document.getElementById("capture-image-btn");
      const capturedImage = document.getElementById("captured-image");
      const capturedImageContainer = document.getElementById("captured-image-container");
      const clearImageBtn = document.getElementById("clear-image-btn");

      const navCalculator = document.getElementById('nav-calculator');
      const navShoppingList = document.getElementById('nav-shopping-list');
      const navCamera = document.getElementById('nav-camera');
      const messageBox = document.getElementById('message-box');
      let geminiApiKey = "";
      let isCameraActive = false;

      // ----------------------------------------------------------------------------------
      // Funções de Utilidade
      // ----------------------------------------------------------------------------------
      
      /**
       * Exibe uma mensagem na tela com um estilo específico.
       * @param {string} message A mensagem a ser exibida.
       * @param {string} type O tipo da mensagem ('success', 'error', 'info').
       */
      function showMessage(message, type) {
        messageBox.textContent = message;
        messageBox.className = "fixed bottom-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 transform scale-100 transition-transform duration-300";
        if (type === 'success') {
          messageBox.classList.add('bg-green-600', 'text-white');
        } else if (type === 'error') {
          messageBox.classList.add('bg-red-600', 'text-white');
        } else {
          messageBox.classList.add('bg-gray-700', 'text-white');
        }
        setTimeout(() => {
          messageBox.classList.remove('scale-100');
          messageBox.classList.add('scale-0');
        }, 3000);
      }
      
      /**
       * Salva os dados no Local Storage.
       * @param {string} key A chave do Local Storage.
       * @param {any} data Os dados a serem salvos.
       */
      function saveDataToLocalStorage(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          showMessage("Erro ao salvar dados localmente.", 'error');
        }
      }

      /**
       * Carrega os dados do Local Storage.
       * @param {string} key A chave do Local Storage.
       * @returns {Array} Os dados carregados, ou um array vazio se houver erro.
       */
      function loadDataFromLocalStorage(key) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          showMessage("Erro ao carregar dados locais.", 'error');
          return [];
        }
      }

      // ----------------------------------------------------------------------------------
      // Lógica da Calculadora
      // ----------------------------------------------------------------------------------
      
      /**
       * Adiciona uma nova linha à tabela da calculadora.
       */
      function addNewRow() {
        const row = tableBody.insertRow();
        row.className = "border-b border-gray-700 last:border-0";
        const newId = tableBody.rows.length;
        row.dataset.id = newId;

        row.innerHTML = `
          <td class="p-2 sm:p-3 text-center text-gray-400 text-sm sm:text-base">${newId < 10 ? '0' + newId : newId}</td>
          <td class="p-2 sm:p-3"><input type="text" name="product" placeholder="Produto" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
          <td class="p-2 sm:p-3"><input type="number" name="unitprice" placeholder="R$" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
          <td class="p-2 sm:p-3"><input type="number" name="quantity" placeholder="Qtd." class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
          <td name="total" class="p-2 sm:p-3 font-semibold text-right text-sm sm:text-base">R$ 0.00</td>
          <td class="p-2 sm:p-3 text-center"><button class="remove-row-btn p-1 rounded-full bg-red-600 hover:bg-red-700 transition-colors shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
            </svg>
          </button></td>
        `;

        // Adiciona listeners para os novos campos
        const unitPriceInput = row.querySelector("input[name='unitprice']");
        const quantityInput = row.querySelector("input[name='quantity']");
        const removeButton = row.querySelector(".remove-row-btn");
        const productInput = row.querySelector("input[name='product']");

        unitPriceInput.addEventListener("input", updateRowTotalAndSave);
        quantityInput.addEventListener("input", updateRowTotalAndSave);
        productInput.addEventListener("input", saveDataFromCalculator);
        removeButton.addEventListener("click", function() {
          row.remove();
          updateTotalAndSave();
        });

        // Salva os dados após a adição da linha
        saveDataFromCalculator();
      }

      /**
       * Atualiza o valor total da linha e salva os dados no Local Storage.
       * @param {Event} event O evento de input.
       */
      function updateRowTotalAndSave(event) {
        const row = event.target.closest('tr');
        const unitPrice = parseFloat(row.querySelector("input[name='unitprice']").value) || 0;
        const quantity = parseFloat(row.querySelector("input[name='quantity']").value) || 0;
        const total = unitPrice * quantity;
        row.querySelector("td[name='total']").textContent = `R$ ${total.toFixed(2)}`;
        updateTotalAndSave();
      }

      /**
       * Calcula o valor total de todos os produtos e salva os dados.
       */
      function updateTotalAndSave() {
        let totalValue = 0;
        const rows = tableBody.querySelectorAll("tr");
        const productsData = [];

        rows.forEach(row => {
          const product = row.querySelector("input[name='product']").value;
          const unitPrice = parseFloat(row.querySelector("input[name='unitprice']").value) || 0;
          const quantity = parseFloat(row.querySelector("input[name='quantity']").value) || 0;
          const total = unitPrice * quantity;
          totalValue += total;
          
          productsData.push({ product, unitPrice, quantity });
        });
        
        totalValueSpan.textContent = `R$ ${totalValue.toFixed(2)}`;
        saveDataToLocalStorage(calculatorLocalStorageKey, productsData);
      }

      /**
       * Salva os dados da calculadora no Local Storage.
       */
      function saveDataFromCalculator() {
        const rows = tableBody.querySelectorAll("tr");
        const productsData = [];
        rows.forEach(row => {
          const product = row.querySelector("input[name='product']").value;
          const unitPrice = parseFloat(row.querySelector("input[name='unitprice']").value) || 0;
          const quantity = parseFloat(row.querySelector("input[name='quantity']").value) || 0;
          productsData.push({ product, unitPrice, quantity });
        });
        saveDataToLocalStorage(calculatorLocalStorageKey, productsData);
      }

      /**
       * Carrega os dados da calculadora do Local Storage.
       */
      function loadDataFromCalculatorLocalStorage() {
        const savedData = loadDataFromLocalStorage(calculatorLocalStorageKey);
        if (savedData.length > 0) {
          savedData.forEach(item => {
            const row = tableBody.insertRow();
            row.className = "border-b border-gray-700 last:border-0";
            const newId = tableBody.rows.length;
            row.dataset.id = newId;

            row.innerHTML = `
              <td class="p-2 sm:p-3 text-center text-gray-400 text-sm sm:text-base">${newId < 10 ? '0' + newId : newId}</td>
              <td class="p-2 sm:p-3"><input type="text" name="product" placeholder="Produto" value="${item.product || ''}" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
              <td class="p-2 sm:p-3"><input type="number" name="unitprice" placeholder="R$" value="${item.unitPrice || ''}" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
              <td class="p-2 sm:p-3"><input type="number" name="quantity" placeholder="Qtd." value="${item.quantity || ''}" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
              <td name="total" class="p-2 sm:p-3 font-semibold text-right text-sm sm:text-base">R$ ${((item.unitPrice || 0) * (item.quantity || 0)).toFixed(2)}</td>
              <td class="p-2 sm:p-3 text-center"><button class="remove-row-btn p-1 rounded-full bg-red-600 hover:bg-red-700 transition-colors shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                </svg>
              </button></td>
            `;

            // Adiciona listeners aos campos
            const unitPriceInput = row.querySelector("input[name='unitprice']");
            const quantityInput = row.querySelector("input[name='quantity']");
            const productInput = row.querySelector("input[name='product']");
            const removeButton = row.querySelector(".remove-row-btn");

            unitPriceInput.addEventListener("input", updateRowTotalAndSave);
            quantityInput.addEventListener("input", updateRowTotalAndSave);
            productInput.addEventListener("input", saveDataFromCalculator);
            removeButton.addEventListener("click", function() {
              row.remove();
              updateTotalAndSave();
            });
          });
          updateTotalAndSave(); // Recalcula o total
        }
      }

      // ----------------------------------------------------------------------------------
      // Lógica da Lista de Compras
      // ----------------------------------------------------------------------------------

      /**
       * Carrega os dados da lista de compras do Local Storage e renderiza a tabela.
       */
      function loadDataFromShoppingListLocalStorage() {
        const savedData = loadDataFromLocalStorage(shoppingListLocalStorageKey);
        shoppingListTableBody.innerHTML = '';
        savedData.forEach((item, index) => {
          renderShoppingListItem(item, index);
        });
      }

      /**
       * Renderiza um único item na tabela da lista de compras.
       * @param {object} item O item a ser renderizado.
       * @param {number} index O índice do item.
       */
      function renderShoppingListItem(item, index) {
        const row = shoppingListTableBody.insertRow();
        row.dataset.id = index;
        row.className = "border-b border-gray-700 last:border-0 hover:bg-gray-800 transition-colors";
        row.innerHTML = `
          <td class="p-2 sm:p-3 text-sm sm:text-base">${item.name}</td>
          <td class="p-2 sm:p-3 text-sm sm:text-base">${item.price ? `R$ ${parseFloat(item.price).toFixed(2)}` : 'N/A'}</td>
          <td class="p-2 sm:p-3 text-center">
            <button class="remove-list-item-btn p-1 rounded-full bg-red-600 hover:bg-red-700 transition-colors shadow-md">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
              </svg>
            </button>
          </td>
        `;

        row.querySelector(".remove-list-item-btn").addEventListener("click", () => {
          let data = loadDataFromLocalStorage(shoppingListLocalStorageKey);
          data.splice(index, 1);
          saveDataToLocalStorage(shoppingListLocalStorageKey, data);
          loadDataFromShoppingListLocalStorage();
        });
      }

      /**
       * Adiciona um novo item manualmente à lista de compras.
       */
      function addManualShoppingItem() {
        const name = newProductNameInput.value.trim();
        const price = newProductPriceInput.value.trim();
        if (name === "") {
          showMessage("Por favor, insira um nome de produto.", "error");
          return;
        }

        let data = loadDataFromLocalStorage(shoppingListLocalStorageKey);
        data.push({ name: name, price: price });
        saveDataToLocalStorage(shoppingListLocalStorageKey, data);
        loadDataFromShoppingListLocalStorage();

        newProductNameInput.value = "";
        newProductPriceInput.value = "";
        showMessage("Produto adicionado à lista!", "success");
      }

      /**
       * Chama a API do Gemini para gerar uma lista de compras.
       * @param {string} prompt O prompt de texto para a IA.
       */
      async function callGeminiApi(prompt) {
        if (!geminiApiKey) {
          apiKeyModal.classList.remove('hidden');
          showMessage("Por favor, insira sua API Key.", "info");
          return;
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

        showMessage("Gerando lista com IA...", "info");

        const payload = {
            contents: [{ parts: [{ text: `Gere uma lista de compras de itens no formato JSON. A lista deve ser um array de objetos, onde cada objeto tem uma chave 'item' e uma chave 'preco'. Não inclua nenhum texto adicional, apenas o JSON. Aqui está o pedido: ${prompt}` }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "item": { "type": "STRING" },
                            "preco": { "type": "STRING" }
                        },
                        "propertyOrdering": ["item", "preco"]
                    }
                }
            }
        };

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
          }
          
          const result = await response.json();
          const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
          const generatedList = JSON.parse(jsonString);

          if (generatedList && Array.isArray(generatedList)) {
            let data = loadDataFromLocalStorage(shoppingListLocalStorageKey);
            const newItems = generatedList.map(item => ({
              name: item.item,
              price: item.preco
            }));
            data = data.concat(newItems);
            saveDataToLocalStorage(shoppingListLocalStorageKey, data);
            loadDataFromShoppingListLocalStorage();
            showMessage("Lista gerada com sucesso!", "success");
          } else {
            throw new Error("Formato de resposta inesperado.");
          }

        } catch (error) {
          console.error("Erro ao gerar lista com IA:", error);
          showMessage("Falha ao gerar lista. Verifique sua API Key ou tente novamente.", "error");
        }
      }

      // ----------------------------------------------------------------------------------
      // Lógica de Salvamento em PDF
      // ----------------------------------------------------------------------------------

      /**
       * Salva a tabela da calculadora como um arquivo PDF.
       */
      function saveTableAsPDF() {
        const doc = new jsPDF();
        
        // Título e data
        const title = 'Lista de Compras - Calculadora';
        const date = new Date().toLocaleDateString('pt-BR');
        doc.setFontSize(22);
        doc.text(title, 10, 20);
        doc.setFontSize(12);
        doc.text(`Gerado em: ${date}`, 10, 28);
        
        // Converte a tabela para imagem com html2canvas
        const table = document.getElementById("tabelaprod");
        html2canvas(table, {
          scale: 2, // Melhor qualidade
          useCORS: true // Permite capturar imagens externas, se houver
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = doc.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          doc.addImage(imgData, 'PNG', 10, 35, pdfWidth - 20, pdfHeight);
          doc.save("lista_produtos.pdf");
          showMessage("PDF salvo com sucesso!", 'success');
        }).catch(error => {
          console.error('Erro ao gerar o PDF:', error);
          showMessage("Erro ao salvar PDF. Tente novamente.", 'error');
        });
      }
      
      // ----------------------------------------------------------------------------------
      // Lógica da Câmera
      // ----------------------------------------------------------------------------------
      
      /**
       * Inicia o stream da câmera traseira.
       */
      async function startCamera() {
        if (!isCameraActive) {
          try {
            // Solicita acesso à câmera traseira do dispositivo
            const constraints = { video: { facingMode: 'environment' } };
            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraVideo.srcObject = cameraStream;
            isCameraActive = true;
            captureImageBtn.classList.remove('hidden');
            startCameraBtn.classList.add('hidden');
            showMessage("Câmera ativada. Pode capturar a imagem.", "success");
          } catch (err) {
            console.error('Erro ao acessar a câmera:', err);
            showMessage("Acesso à câmera negado ou indisponível.", "error");
            isCameraActive = false;
          }
        }
      }

      /**
       * Para o stream da câmera.
       */
      function stopCamera() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraVideo.srcObject = null;
          isCameraActive = false;
          captureImageBtn.classList.add('hidden');
          startCameraBtn.classList.remove('hidden');
        }
      }

      /**
       * Captura uma imagem do stream de vídeo e a exibe.
       */
      function captureImage() {
        if (!isCameraActive) {
          showMessage("A câmera não está ativa.", "error");
          return;
        }

        // Configura o canvas para a mesma resolução do vídeo
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;
        const context = cameraCanvas.getContext('2d');
        
        // Desenha o frame atual do vídeo no canvas
        context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
        
        // Converte a imagem do canvas para uma URL base64 e exibe
        const imageDataUrl = cameraCanvas.toDataURL('image/png');
        capturedImage.src = imageDataUrl;
        capturedImageContainer.classList.remove('hidden');
        
        // Para a câmera para economizar bateria
        stopCamera();
        
        showMessage("Imagem capturada com sucesso!", "success");
        // Loga a URL da imagem no console para teste
        console.log("Imagem capturada (Base64):", imageDataUrl.substring(0, 50) + "...");
      }

      // ----------------------------------------------------------------------------------
      // Lógica dos Modais e Event Listeners
      // ----------------------------------------------------------------------------------

      // Event Listeners da Calculadora
      addButton.addEventListener("click", addNewRow);
      savePDFButton.addEventListener("click", saveTableAsPDF);

      // Event Listeners da Lista de Compras
      addProductListButton.addEventListener("click", addManualShoppingItem);
      generateListButton.addEventListener("click", () => {
        const promptText = geminiPromptInput.value.trim();
        if (promptText) {
          callGeminiApi(promptText);
        } else {
          showMessage("Por favor, digite o que você precisa.", "error");
        }
      });

      // Event Listeners da Câmera
      startCameraBtn.addEventListener('click', startCamera);
      captureImageBtn.addEventListener('click', captureImage);
      clearImageBtn.addEventListener('click', () => {
        capturedImageContainer.classList.add('hidden');
        capturedImage.src = "";
        showMessage("Imagem limpa.", "info");
      });
      
      // Event Listeners dos Modais
      modalContinueButton.addEventListener('click', () => {
        geminiApiKey = modalApiKeyInput.value.trim();
        apiKeyModal.classList.add('hidden');
        if (geminiApiKey) {
          const promptText = geminiPromptInput.value.trim();
          if (promptText) {
            callGeminiApi(promptText);
          }
        } else {
          showMessage("API Key inválida.", 'error');
        }
      });

      modalCancelButton.addEventListener('click', () => {
        apiKeyModal.classList.add('hidden');
        showMessage("Funcionalidade de IA ignorada.", 'info');
      });

      instructionsButton.addEventListener("click", () => {
        instructionsModal.classList.remove("hidden");
      });

      closeInstructions.addEventListener("click", () => {
        instructionsModal.classList.add("hidden");
      });
      
      // ----------------------------------------------------------------------------------
      // Navegação e Lógica de Segurança
      // ----------------------------------------------------------------------------------

      // Gerencia qual página está visível
      function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        
        // Lógica de segurança: para a câmera se a página for trocada
        if (pageId !== 'camera-page') {
          stopCamera();
        }
      }

      // Event listeners para os botões de navegação
      navCalculator.addEventListener('click', () => showPage('calculator-page'));
      navShoppingList.addEventListener('click', () => showPage('shopping-list-page'));
      navCamera.addEventListener('click', () => showPage('camera-page'));

      // Lógica de segurança: para a câmera quando a página não está ativa
      document.addEventListener('visibilitychange', () => {
        const onCameraPage = !cameraPage.classList.contains('hidden');
        if (document.hidden && isCameraActive) {
          stopCamera();
          showMessage("Câmera desativada por segurança (página em segundo plano).", "info");
        } else if (!document.hidden && onCameraPage) {
          // Opcional: Reativar a câmera automaticamente ou com um aviso
          // startCamera(); // Esta linha poderia ser re-habilitada para reativar automaticamente
          showMessage("Câmera pode ser reativada. Clique no botão Iniciar.", "info");
        }
      });
      
      // ----------------------------------------------------------------------------------
      // Inicialização
      // ----------------------------------------------------------------------------------
      showPage('calculator-page');
      loadDataFromCalculatorLocalStorage();
      loadDataFromShoppingListLocalStorage();
    });
  </script>
</body>
</html>
