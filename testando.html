<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App de Compras</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Bibliotecas de terceiros -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Estilo de fonte global */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Classe para esconder elementos */
    .hidden {
      display: none !important;
    }
    /* Estilo para a tabela em telas pequenas */
    .table-container {
      overflow-x: auto;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Navbar responsiva -->
  <nav class="bg-gray-800 p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center">
    <span class="font-bold text-xl sm:text-2xl mb-2 sm:mb-0 text-center">App de Compras</span>
    <div class="flex justify-center space-x-4">
      <button id="nav-calculator" class="py-2 px-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-colors">Calculadora</button>
      <button id="nav-shopping-list" class="py-2 px-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-colors">Lista de Compras</button>
      <button id="nav-logs" class="py-2 px-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-colors">Logs</button>
    </div>
  </nav>

  <!-- Container principal, com padding responsivo e flexbox -->
  <main class="flex-grow p-4 sm:p-6 lg:p-8">

    <!-- Caixa de mensagens -->
    <div id="message-box" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 transition-transform duration-300 transform scale-0 origin-bottom"></div>

    <!-- Página Calculadora -->
    <div id="calculator-page" class="page-content flex flex-col gap-6">
      <h1 class="text-2xl font-bold text-center sm:text-3xl">Calculadora de Preços</h1>
      <p class="text-center text-gray-400 max-w-2xl mx-auto">Adicione produtos para calcular o valor total de suas compras. Você pode adicionar, remover e exportar a lista para PDF.</p>

      <div class="table-container bg-gray-800 rounded-lg shadow-lg p-4">
        <table id="tabelaprod" class="w-full text-left table-auto">
          <thead class="bg-gray-700 text-gray-200 uppercase text-xs sm:text-sm">
            <tr>
              <th class="p-2 sm:p-3 rounded-tl-lg">ID</th>
              <th class="p-2 sm:p-3">Produto</th>
              <th class="p-2 sm:p-3">Preço</th>
              <th class="p-2 sm:p-3">Qtd.</th>
              <th class="p-2 sm:p-3 rounded-tr-lg">Total</th>
              <th class="p-2 sm:p-3">Ação</th>
            </tr>
          </thead>
          <tbody>
            <!-- Linhas da tabela serão inseridas aqui via JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4">
        <button id="addButton" class="flex-1 py-3 px-6 rounded-full bg-green-500 hover:bg-green-600 transition-colors shadow-md text-sm sm:text-base font-semibold">Adicionar Produto</button>
        <button id="cameraScanBtn" class="flex-1 py-3 px-6 rounded-full bg-blue-500 hover:bg-blue-600 transition-colors shadow-md text-sm sm:text-base font-semibold">Identificar com Câmera</button>
        <button id="savePDFButton" class="flex-1 py-3 px-6 rounded-full bg-red-500 hover:bg-red-600 transition-colors shadow-md text-sm sm:text-base font-semibold">Salvar PDF</button>
      </div>

      <div class="flex justify-center items-center gap-2 text-xl font-bold mt-4">
        <span>Valor Total:</span>
        <span id="totalvalue" class="text-blue-400">R$ 0.00</span>
      </div>
    </div>

    <!-- Página Lista de Compras -->
    <div id="shopping-list-page" class="page-content hidden flex flex-col gap-6">
      <h1 class="text-2xl font-bold text-center sm:text-3xl">Gerador de Lista de Compras com IA</h1>
      <p class="text-center text-gray-400 max-w-2xl mx-auto">Use a IA do Gemini para gerar uma lista de compras com base na sua necessidade, ou crie a sua própria lista manualmente.</p>

      <div class="bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col gap-4">
        <label for="gemini-prompt" class="block text-sm font-medium text-gray-200">Qual lista de compras você precisa?</label>
        <div class="flex flex-col sm:flex-row gap-4 items-end">
          <input type="text" id="gemini-prompt" placeholder="Ex: 'ingredientes para bolo de chocolate'" class="flex-grow w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button id="generate-list-button" class="py-3 px-6 rounded-full bg-purple-500 hover:bg-purple-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto">Gerar Lista com IA</button>
          <button id="instructionsButton" class="py-3 px-6 rounded-full bg-gray-500 hover:bg-gray-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto">Instruções</button>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row gap-4">
          <input type="text" id="new-product-name" placeholder="Nome do Produto" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <input type="number" id="new-product-price" placeholder="Preço (Opcional)" class="w-full sm:w-1/3 bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button id="add-product-list-button" class="py-3 px-6 rounded-full bg-green-500 hover:bg-green-600 transition-colors shadow-md text-sm sm:text-base font-semibold w-full sm:w-auto">Adicionar</button>
        </div>
        
        <div class="table-container">
          <table id="shopping-list-table" class="w-full text-left">
            <thead class="bg-gray-700 text-gray-200 uppercase text-xs sm:text-sm">
              <tr>
                <th class="p-2 sm:p-3 rounded-tl-lg">Item</th>
                <th class="p-2 sm:p-3">Preço</th>
                <th class="p-2 sm:p-3 rounded-tr-lg">Ação</th>
              </tr>
            </thead>
            <tbody>
              <!-- Itens da lista serão inseridos aqui -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Página de Logs -->
    <div id="logs-page" class="page-content hidden flex flex-col gap-6">
      <h1 class="text-2xl font-bold text-center sm:text-3xl">Logs do Sistema</h1>
      <p class="text-center text-gray-400 max-w-2xl mx-auto">Aqui você pode visualizar as atividades e notificações do aplicativo.</p>
      
      <div class="flex flex-col sm:flex-row justify-end gap-4">
        <button id="exportLogsBtn" class="py-3 px-6 rounded-full bg-red-500 hover:bg-red-600 transition-colors shadow-md text-sm sm:text-base font-semibold">Exportar Logs para PDF</button>
      </div>

      <div class="table-container bg-gray-800 rounded-lg shadow-lg p-4 mt-4">
        <table id="logs-table" class="w-full text-left table-auto">
          <thead class="bg-gray-700 text-gray-200 uppercase text-xs sm:text-sm">
            <tr>
              <th class="p-2 sm:p-3 rounded-tl-lg">Data/Horário</th>
              <th class="p-2 sm:p-3">Dispositivo</th>
              <th class="p-2 sm:p-3 rounded-tr-lg">Mensagem</th>
            </tr>
          </thead>
          <tbody id="logs-table-body">
            <!-- Linhas da tabela de logs serão inseridas aqui via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>


    <!-- Modal para Identificação de Produto por Câmera -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-gray-800 text-white p-8 rounded-xl w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 shadow-2xl relative">
        <h2 class="text-xl font-bold mb-4 text-center">Identificar Produto com Câmera</h2>
        
        <!-- Contêiner do vídeo da câmera -->
        <div class="w-full aspect-video rounded-lg overflow-hidden mb-4 bg-gray-900">
          <video id="camera-video" class="w-full h-full object-cover" autoplay playsinline></video>
        </div>
        <canvas id="camera-canvas" class="hidden"></canvas>

        <!-- Botões de ação da câmera -->
        <div class="flex justify-center gap-4 mb-4">
          <button id="capture-image-btn" class="py-3 px-6 rounded-full bg-purple-500 hover:bg-purple-600 transition-colors shadow-md text-sm sm:text-base font-semibold">
            Capturar
          </button>
        </div>

        <!-- Formulário para o produto identificado -->
        <div id="product-form" class="hidden flex flex-col gap-4">
          <p class="text-center font-bold">Produto Identificado:</p>
          <input type="text" id="identified-product-name" placeholder="Nome do Produto" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <input type="number" id="modal-unit-price" placeholder="Valor Unit." class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <input type="number" id="modal-quantity" placeholder="Quantidade" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        
        <!-- Botões de ação do modal -->
        <div class="flex justify-end gap-2 mt-4">
          <button id="modal-cancel-button" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
          <button id="modal-add-button" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors hidden">Adicionar</button>
        </div>
      </div>
    </div>

    <!-- Modal de API Key -->
    <div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-gray-800 text-white p-8 rounded-xl w-11/12 sm:w-96 shadow-2xl relative">
        <h2 class="text-xl font-bold mb-4 text-center">API Key do Gemini</h2>
        <p class="text-sm text-center mb-4 text-gray-400">Para usar a IA, você precisa da sua API Key.</p>
        <input type="text" id="modal-api-key-input" placeholder="Cole sua API Key aqui" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <div class="flex justify-end gap-2">
          <button id="modal-cancel-api-button" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
          <button id="modal-continue-button" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">Continuar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Instruções -->
    <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
      <div class="bg-gray-800 text-white p-8 rounded-xl w-11/12 sm:w-96 shadow-2xl relative">
        <h2 class="text-xl font-bold mb-4 text-center">Como obter sua API Key do Gemini</h2>
        <ol class="list-decimal ml-5 space-y-2 text-sm text-gray-300">
          <li>Acesse <a href="https://aistudio.google.com" target="_blank" class="text-blue-400 underline hover:text-blue-300 transition-colors">aistudio.google.com</a></li>
          <li>Faça login com sua conta Google.</li>
          <li>No menu lateral, clique em <b>Get API Key</b>.</li>
          <li>Clique em <b>Create API key in new project</b>.</li>
          <li>Copie a chave gerada e cole no campo acima.</li>
        </ol>
        <div class="flex justify-end mt-6">
          <button id="closeInstructions" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">Fechar</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Referência global para o objeto jsPDF
    let jsPDF;
    // Variável global para armazenar o stream da câmera
    let cameraStream = null;
    let geminiApiKey = "";
    let systemLogs = []; // Array para armazenar os logs
    // Variável global para informações do dispositivo
    let deviceAndIpInfo = "";

    // Função para carregar dinamicamente o jsPDF
    async function loadJsPDF() {
      if (typeof window.jspdf === 'undefined') {
        const { jsPDF: jsPDFModule } = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        jsPDF = jsPDFModule;
      } else {
        jsPDF = window.jspdf.jsPDF;
      }
    }

    /**
     * Tenta buscar o endereço IP público e o agente do navegador.
     * Retorna uma string formatada ou uma mensagem de erro.
     */
    async function fetchDeviceInfoAndIP() {
        let ip = "Não disponível";
        try {
            const response = await fetch("https://api.ipify.org?format=json");
            if (response.ok) {
                const data = await response.json();
                ip = data.ip;
            } else {
                console.error("Erro ao obter o IP: Resposta não OK", response.status);
            }
        } catch (error) {
            console.error("Erro ao obter o IP:", error);
        }
        return `Navegador: ${navigator.userAgent} | IP: ${ip}`;
    }

    // Espera o DOM carregar completamente
    document.addEventListener("DOMContentLoaded", async function() {
      // ----------------------------------------------------------------------------------
      // Seletores comuns
      // ----------------------------------------------------------------------------------
      const calculatorPage = document.getElementById("calculator-page");
      const tableBody = document.querySelector("#tabelaprod tbody");
      const addButton = document.getElementById("addButton");
      const cameraScanBtn = document.getElementById("cameraScanBtn");
      const savePDFButton = document.getElementById("savePDFButton");
      const totalValueSpan = document.getElementById("totalvalue");
      const calculatorLocalStorageKey = "productCalculatorData";

      const shoppingListPage = document.getElementById("shopping-list-page");
      const newProductNameInput = document.getElementById("new-product-name");
      const newProductPriceInput = document.getElementById("new-product-price");
      const addProductListButton = document.getElementById("add-product-list-button");
      const shoppingListTableBody = document.querySelector("#shopping-list-table tbody");
      const shoppingListLocalStorageKey = "shoppingListData";
      
      const logsPage = document.getElementById("logs-page");
      const logsTableBody = document.getElementById("logs-table-body");
      const exportLogsBtn = document.getElementById("exportLogsBtn");

      const geminiPromptInput = document.getElementById("gemini-prompt");
      const generateListButton = document.getElementById("generate-list-button");
      const apiKeyModal = document.getElementById("api-key-modal");
      const modalApiKeyInput = document.getElementById("modal-api-key-input");
      const modalContinueButton = document.getElementById("modal-continue-button");
      const modalCancelApiButton = document.getElementById("modal-cancel-api-button");
      const instructionsButton = document.getElementById("instructionsButton");
      const instructionsModal = document.getElementById("instructions-modal");
      const closeInstructions = document.getElementById("closeInstructions");

      const navCalculator = document.getElementById('nav-calculator');
      const navShoppingList = document.getElementById('nav-shopping-list');
      const navLogs = document.getElementById('nav-logs');
      const messageBox = document.getElementById('message-box');

      // Seletores do novo modal de câmera
      const cameraModal = document.getElementById("camera-modal");
      const cameraVideo = document.getElementById("camera-video");
      const cameraCanvas = document.getElementById("camera-canvas");
      const captureImageBtn = document.getElementById("capture-image-btn");
      const identifiedProductNameInput = document.getElementById("identified-product-name");
      const modalUnitPriceInput = document.getElementById("modal-unit-price");
      const modalQuantityInput = document.getElementById("modal-quantity");
      const modalAddButton = document.getElementById("modal-add-button");
      const modalCancelButton = document.getElementById("modal-cancel-button");
      const productForm = document.getElementById("product-form");
      let isCameraActive = false;
      
      // Carrega bibliotecas e informações do dispositivo
      await loadJsPDF();
      deviceAndIpInfo = await fetchDeviceInfoAndIP();
      addLogEntry("Aplicação iniciada.", "info");

      // ----------------------------------------------------------------------------------
      // Funções de Utilidade
      // ----------------------------------------------------------------------------------

      /**
       * Adiciona uma entrada de log ao array e renderiza a tabela.
       * @param {string} message A mensagem do log.
       * @param {string} type O tipo de mensagem ('success', 'error', 'info').
       */
      function addLogEntry(message, type) {
        const now = new Date();
        const timestamp = now.toLocaleString('pt-BR');
        
        const logEntry = {
          timestamp,
          device: deviceAndIpInfo,
          message,
          type
        };

        systemLogs.push(logEntry);
        // Limita o número de logs para evitar sobrecarregar a memória
        if (systemLogs.length > 50) {
          systemLogs.shift();
        }
        renderLogTable();
      }
      
      /**
       * Exibe uma mensagem na tela e adiciona ao log.
       * @param {string} message A mensagem a ser exibida.
       * @param {string} type O tipo da mensagem ('success', 'error', 'info').
       */
      function showMessage(message, type) {
        // Adiciona a mensagem ao log antes de exibi-la
        addLogEntry(message, type);

        messageBox.textContent = message;
        messageBox.className = "fixed bottom-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 transform scale-100 transition-transform duration-300";
        if (type === 'success') {
          messageBox.classList.add('bg-green-600', 'text-white');
        } else if (type === 'error') {
          messageBox.classList.add('bg-red-600', 'text-white');
        } else {
          messageBox.classList.add('bg-gray-700', 'text-white');
        }
        setTimeout(() => {
          messageBox.classList.remove('scale-100');
          messageBox.classList.add('scale-0');
        }, 3000);
      }
      
      /**
       * Salva os dados no Local Storage.
       * @param {string} key A chave do Local Storage.
       * @param {any} data Os dados a serem salvos.
       */
      function saveDataToLocalStorage(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          showMessage("Erro ao salvar dados localmente.", 'error');
        }
      }

      /**
       * Carrega os dados do Local Storage.
       * @param {string} key A chave do Local Storage.
       * @returns {Array} Os dados carregados, ou um array vazio se houver erro.
       */
      function loadDataFromLocalStorage(key) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          showMessage("Erro ao carregar dados locais.", 'error');
          return [];
        }
      }

      // ----------------------------------------------------------------------------------
      // Lógica da Calculadora
      // ----------------------------------------------------------------------------------
      
      /**
       * Adiciona uma nova linha à tabela da calculadora.
       * @param {string} product O nome do produto (opcional).
       * @param {number} unitPrice O preço unitário (opcional).
       * @param {number} quantity A quantidade (opcional).
       */
      function addNewRow(product = '', unitPrice = '', quantity = '') {
        const row = tableBody.insertRow();
        row.className = "border-b border-gray-700 last:border-0";
        const newId = tableBody.rows.length;
        row.dataset.id = newId;

        row.innerHTML = `
          <td class="p-2 sm:p-3 text-center text-gray-400 text-sm sm:text-base">${newId < 10 ? '0' + newId : newId}</td>
          <td class="p-2 sm:p-3"><input type="text" name="product" placeholder="Produto" value="${product}" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
          <td class="p-2 sm:p-3"><input type="number" name="unitprice" placeholder="R$" value="${unitPrice}" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
          <td class="p-2 sm:p-3"><input type="number" name="quantity" placeholder="Qtd." value="${quantity}" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" /></td>
          <td name="total" class="p-2 sm:p-3 font-semibold text-right text-sm sm:text-base">R$ 0.00</td>
          <td class="p-2 sm:p-3 text-center"><button class="remove-row-btn p-1 rounded-full bg-red-600 hover:bg-red-700 transition-colors shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
            </svg>
          </button></td>
        `;

        // Adiciona listeners para os novos campos
        const unitPriceInput = row.querySelector("input[name='unitprice']");
        const quantityInput = row.querySelector("input[name='quantity']");
        const removeButton = row.querySelector(".remove-row-btn");
        const productInput = row.querySelector("input[name='product']");

        unitPriceInput.addEventListener("input", updateRowTotalAndSave);
        quantityInput.addEventListener("input", updateRowTotalAndSave);
        productInput.addEventListener("input", saveDataFromCalculator);
        removeButton.addEventListener("click", function() {
          row.remove();
          updateTotalAndSave();
        });

        // Atualiza o total se os valores forem preenchidos
        updateRowTotal(row);
        saveDataFromCalculator();
      }
      
      /**
       * Atualiza o valor total de uma única linha da tabela.
       * @param {HTMLElement} row O elemento tr da linha.
       */
      function updateRowTotal(row) {
        const unitPrice = parseFloat(row.querySelector("input[name='unitprice']").value) || 0;
        const quantity = parseFloat(row.querySelector("input[name='quantity']").value) || 0;
        const total = unitPrice * quantity;
        row.querySelector("td[name='total']").textContent = `R$ ${total.toFixed(2)}`;
        updateTotalAndSave();
      }

      /**
       * Atualiza o valor total da linha e salva os dados no Local Storage.
       * @param {Event} event O evento de input.
       */
      function updateRowTotalAndSave(event) {
        const row = event.target.closest('tr');
        updateRowTotal(row);
      }

      /**
       * Calcula o valor total de todos os produtos e salva os dados.
       */
      function updateTotalAndSave() {
        let totalValue = 0;
        const rows = tableBody.querySelectorAll("tr");
        const productsData = [];

        rows.forEach(row => {
          const product = row.querySelector("input[name='product']").value;
          const unitPrice = parseFloat(row.querySelector("input[name='unitprice']").value) || 0;
          const quantity = parseFloat(row.querySelector("input[name='quantity']").value) || 0;
          const total = unitPrice * quantity;
          totalValue += total;
          
          productsData.push({ product, unitPrice, quantity });
        });
        
        totalValueSpan.textContent = `R$ ${totalValue.toFixed(2)}`;
        saveDataToLocalStorage(calculatorLocalStorageKey, productsData);
      }

      /**
       * Salva os dados da calculadora no Local Storage.
       */
      function saveDataFromCalculator() {
        const rows = tableBody.querySelectorAll("tr");
        const productsData = [];
        rows.forEach(row => {
          const product = row.querySelector("input[name='product']").value;
          const unitPrice = parseFloat(row.querySelector("input[name='unitprice']").value) || 0;
          const quantity = parseFloat(row.querySelector("input[name='quantity']").value) || 0;
          productsData.push({ product, unitPrice, quantity });
        });
        saveDataToLocalStorage(calculatorLocalStorageKey, productsData);
      }

      /**
       * Carrega os dados da calculadora do Local Storage.
       */
      function loadDataFromCalculatorLocalStorage() {
        const savedData = loadDataFromLocalStorage(calculatorLocalStorageKey);
        if (savedData.length > 0) {
          savedData.forEach(item => {
            addNewRow(item.product, item.unitPrice, item.quantity);
          });
          updateTotalAndSave(); // Recalcula o total
        }
      }

      // ----------------------------------------------------------------------------------
      // Lógica da Lista de Compras
      // ----------------------------------------------------------------------------------

      /**
       * Carrega os dados da lista de compras do Local Storage e renderiza a tabela.
       */
      function loadDataFromShoppingListLocalStorage() {
        const savedData = loadDataFromLocalStorage(shoppingListLocalStorageKey);
        shoppingListTableBody.innerHTML = '';
        savedData.forEach((item, index) => {
          renderShoppingListItem(item, index);
        });
      }

      /**
       * Renderiza um único item na tabela da lista de compras.
       * @param {object} item O item a ser renderizado.
       * @param {number} index O índice do item.
       */
      function renderShoppingListItem(item, index) {
        const row = shoppingListTableBody.insertRow();
        row.dataset.id = index;
        row.className = "border-b border-gray-700 last:border-0 hover:bg-gray-800 transition-colors";
        row.innerHTML = `
          <td class="p-2 sm:p-3 text-sm sm:text-base">${item.name}</td>
          <td class="p-2 sm:p-3 text-sm sm:text-base">${item.price ? `R$ ${parseFloat(item.price).toFixed(2)}` : 'N/A'}</td>
          <td class="p-2 sm:p-3 text-center">
            <button class="remove-list-item-btn p-1 rounded-full bg-red-600 hover:bg-red-700 transition-colors shadow-md">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
              </svg>
            </button>
          </td>
        `;

        row.querySelector(".remove-list-item-btn").addEventListener("click", () => {
          let data = loadDataFromLocalStorage(shoppingListLocalStorageKey);
          data.splice(index, 1);
          saveDataToLocalStorage(shoppingListLocalStorageKey, data);
          loadDataFromShoppingListLocalStorage();
        });
      }

      /**
       * Adiciona um novo item manualmente à lista de compras.
       */
      function addManualShoppingItem() {
        const name = newProductNameInput.value.trim();
        const price = newProductPriceInput.value.trim();
        if (name === "") {
          showMessage("Por favor, insira um nome de produto.", "error");
          return;
        }

        let data = loadDataFromLocalStorage(shoppingListLocalStorageKey);
        data.push({ name: name, price: price });
        saveDataToLocalStorage(shoppingListLocalStorageKey, data);
        loadDataFromShoppingListLocalStorage();

        newProductNameInput.value = "";
        newProductPriceInput.value = "";
        showMessage("Produto adicionado à lista!", "success");
      }

      /**
       * Chama a API do Gemini para gerar uma lista de compras.
       * @param {string} prompt O prompt de texto para a IA.
       */
      async function callGeminiApi(prompt) {
        if (!geminiApiKey) {
          apiKeyModal.classList.remove('hidden');
          showMessage("Por favor, insira sua API Key.", "info");
          return;
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

        showMessage("Gerando lista com IA...", "info");

        const payload = {
            contents: [{ parts: [{ text: `Gere uma lista de compras de itens no formato JSON. A lista deve ser um array de objetos, onde cada objeto tem uma chave 'item' e uma chave 'preco'. Não inclua nenhum texto adicional, apenas o JSON. Aqui está o pedido: ${prompt}` }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "item": { "type": "STRING" },
                            "preco": { "type": "STRING" }
                        },
                        "propertyOrdering": ["item", "preco"]
                    }
                }
            }
        };

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
          }
          
          const result = await response.json();
          const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
          const generatedList = JSON.parse(jsonString);

          if (generatedList && Array.isArray(generatedList)) {
            let data = loadDataFromLocalStorage(shoppingListLocalStorageKey);
            const newItems = generatedList.map(item => ({
              name: item.item,
              price: item.preco
            }));
            data = data.concat(newItems);
            saveDataToLocalStorage(shoppingListLocalStorageKey, data);
            loadDataFromShoppingListLocalStorage();
            showMessage("Lista gerada com sucesso!", "success");
          } else {
            throw new Error("Formato de resposta inesperado.");
          }

        } catch (error) {
          console.error("Erro ao gerar lista com IA:", error);
          showMessage("Falha ao gerar lista. Verifique sua API Key ou tente novamente.", "error");
        }
      }

      // ----------------------------------------------------------------------------------
      // Lógica de Salvamento em PDF
      // ----------------------------------------------------------------------------------

      /**
       * Salva a tabela da calculadora como um arquivo PDF.
       */
      function saveTableAsPDF() {
        const doc = new jsPDF();
        
        // Título e data
        const title = 'Lista de Compras - Calculadora';
        const date = new Date().toLocaleDateString('pt-BR');
        doc.setFontSize(22);
        doc.text(title, 10, 20);
        doc.setFontSize(12);
        doc.text(`Gerado em: ${date}`, 10, 28);
        
        // Converte a tabela para imagem com html2canvas
        const table = document.getElementById("tabelaprod");
        html2canvas(table, {
          scale: 2, // Melhor qualidade
          useCORS: true // Permite capturar imagens externas, se houver
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = doc.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          doc.addImage(imgData, 'PNG', 10, 35, pdfWidth - 20, pdfHeight);
          doc.save("lista_produtos.pdf");
          showMessage("PDF salvo com sucesso!", 'success');
        }).catch(error => {
          console.error('Erro ao gerar o PDF:', error);
          showMessage("Erro ao salvar PDF. Tente novamente.", 'error');
        });
      }
      
      // ----------------------------------------------------------------------------------
      // Lógica da Câmera e Identificação de Produto
      // ----------------------------------------------------------------------------------
      
      /**
       * Inicia o stream da câmera traseira.
       */
      async function startCamera() {
        if (!isCameraActive) {
          try {
            const constraints = { video: { facingMode: 'environment' } };
            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraVideo.srcObject = cameraStream;
            isCameraActive = true;
          } catch (err) {
            console.error('Erro ao acessar a câmera:', err);
            showMessage("Acesso à câmera negado ou indisponível.", "error");
            isCameraActive = false;
            // Fecha o modal se a câmera não puder ser ativada
            cameraModal.classList.add('hidden');
          }
        }
      }

      /**
       * Para o stream da câmera.
       */
      function stopCamera() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraVideo.srcObject = null;
          isCameraActive = false;
        }
      }

      /**
       * Captura uma imagem do stream de vídeo, chama a IA para identificar o produto e preenche o modal.
       */
      async function captureAndIdentify() {
        // Verifica se a câmera está ativa antes de capturar
        if (!isCameraActive) {
          showMessage("A câmera não está ativa. Por favor, reinicie a identificação.", "error");
          return;
        }
        
        // Verifica se a API Key foi fornecida antes de chamar a IA
        if (!geminiApiKey) {
          apiKeyModal.classList.remove('hidden');
          showMessage("Por favor, insira sua API Key para usar a identificação por IA.", "info");
          return;
        }

        // Para a câmera imediatamente para economizar recursos
        stopCamera();

        // Configura o canvas para a mesma resolução do vídeo
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;
        const context = cameraCanvas.getContext('2d');
        context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
        
        // Converte a imagem para uma URL base64
        const imageDataUrl = cameraCanvas.toDataURL('image/png');
        const base64Data = imageDataUrl.split(',')[1];

        showMessage("Identificando produto...", "info");
        productForm.classList.add('hidden');
        modalAddButton.classList.add('hidden');
        
        // Chama a API do Gemini para identificar o produto
        try {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
          const payload = {
            contents: [{
              parts: [
                // Prompt para a IA, instruindo-a a responder apenas com o nome do produto
                { text: `Identifique o produto principal nesta imagem. Responda APENAS com o nome do produto. Se não puder identificar, responda com 'Produto não identificado'.` },
                { inlineData: { mimeType: "image/png", data: base64Data } }
              ]
            }],
          };
          
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          // Trata erros da resposta da API, como status 400, 403, etc.
          if (!response.ok) {
            const errorData = await response.json();
            console.error('Erro na resposta da API:', errorData);
            let errorMessage = "Erro na API. Verifique sua chave e tente novamente.";
            if (response.status === 400 && errorData.error && errorData.error.message.includes("API key not valid")) {
                errorMessage = "API Key inválida. Por favor, verifique a chave no modal de instruções.";
            }
            throw new Error(errorMessage);
          }
          
          const result = await response.json();
          // Extrai o nome do produto da resposta da IA
          const identifiedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Produto não identificado';
          
          identifiedProductNameInput.value = identifiedText.trim();
          productForm.classList.remove('hidden');
          modalAddButton.classList.remove('hidden');
          showMessage("Identificação completa!", "success");

        } catch (error) {
          console.error("Erro na identificação com IA:", error);
          identifiedProductNameInput.value = "Erro na identificação";
          showMessage(`Falha na identificação do produto: ${error.message}`, "error");
          productForm.classList.remove('hidden');
          modalAddButton.classList.remove('hidden');
        }
      }
      
      // ----------------------------------------------------------------------------------
      // Lógica de Logs
      // ----------------------------------------------------------------------------------
      
      /**
       * Renderiza a tabela de logs com os dados mais recentes.
       */
      function renderLogTable() {
        // Limpa a tabela
        logsTableBody.innerHTML = '';
        
        // Adiciona as novas linhas, do mais recente para o mais antigo
        systemLogs.slice().reverse().forEach(log => {
          const row = logsTableBody.insertRow();
          row.className = `border-b border-gray-700 text-sm sm:text-base ${log.type === 'error' ? 'bg-red-900 text-red-200' : 'bg-gray-800'}`;
          
          const timestampCell = row.insertCell(0);
          timestampCell.textContent = log.timestamp;
          timestampCell.className = "p-2 sm:p-3 break-words";

          const deviceCell = row.insertCell(1);
          deviceCell.textContent = log.device;
          deviceCell.className = "p-2 sm:p-3 break-words";

          const messageCell = row.insertCell(2);
          messageCell.textContent = log.message;
          messageCell.className = "p-2 sm:p-3 break-words";
        });
      }

      /**
       * Exporta os logs para um arquivo PDF.
       */
      function exportLogsToPDF() {
        if (systemLogs.length === 0) {
          showMessage("Não há logs para exportar.", "info");
          return;
        }

        showMessage("Exportando logs para PDF...", "info");
        const doc = new jsPDF();
        let y = 20;
        const margin = 10;
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // Título e cabeçalho
        doc.setFontSize(16);
        doc.text("Logs do Sistema", margin, y);
        y += 10;
        doc.setFontSize(10);
        
        const headers = ["Data/Horário", "Dispositivo", "Mensagem"];
        const columnWidths = [45, 80, 75]; // Larguras ajustadas para as colunas

        // Desenha a linha do cabeçalho
        doc.setFont("helvetica", "bold");
        doc.text(headers[0], margin, y);
        doc.text(headers[1], margin + columnWidths[0], y);
        doc.text(headers[2], margin + columnWidths[0] + columnWidths[1], y);
        doc.setFont("helvetica", "normal");
        y += 5;
        doc.setLineWidth(0.5);
        doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y);
        y += 5;

        // Itera sobre os logs e adiciona ao PDF
        doc.setFontSize(8);
        systemLogs.forEach(log => {
          // Verifica se precisa de uma nova página
          if (y + 10 > pageHeight - margin) {
            doc.addPage();
            y = margin + 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text(headers[0], margin, y);
            doc.text(headers[1], margin + columnWidths[0], y);
            doc.text(headers[2], margin + columnWidths[0] + columnWidths[1], y);
            doc.setFont("helvetica", "normal");
            y += 5;
            doc.setLineWidth(0.5);
            doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y);
            y += 5;
            doc.setFontSize(8);
          }

          // Adiciona a linha do log
          const formattedText = [log.timestamp, log.device, log.message];
          
          // Usa a função `splitTextToSize` para quebrar a mensagem se for muito longa
          const messageLines = doc.splitTextToSize(formattedText[2], columnWidths[2] - 5);
          
          doc.text(formattedText[0], margin, y);
          doc.text(formattedText[1], margin + columnWidths[0], y);
          doc.text(messageLines, margin + columnWidths[0] + columnWidths[1], y);
          
          // Calcula a próxima posição Y com base no número de linhas da mensagem
          y += (messageLines.length * 4) + 2; // Ajusta o espaçamento
        });

        // Salva o documento
        doc.save("logs_do_sistema.pdf");
        showMessage("PDF dos logs salvo com sucesso!", "success");
      }


      // ----------------------------------------------------------------------------------
      // Lógica dos Modais e Event Listeners
      // ----------------------------------------------------------------------------------

      // Event Listeners da Calculadora
      addButton.addEventListener("click", () => addNewRow());
      savePDFButton.addEventListener("click", saveTableAsPDF);
      
      // Novo Event Listener para o botão de câmera
      cameraScanBtn.addEventListener("click", () => {
        cameraModal.classList.remove('hidden');
        startCamera();
      });

      // Event Listeners da Lista de Compras
      addProductListButton.addEventListener("click", addManualShoppingItem);
      generateListButton.addEventListener("click", () => {
        const promptText = geminiPromptInput.value.trim();
        if (promptText) {
          callGeminiApi(promptText);
        } else {
          showMessage("Por favor, digite o que você precisa.", "error");
        }
      });
      
      // Event Listener para exportar os logs
      exportLogsBtn.addEventListener("click", exportLogsToPDF);

      // Event Listeners do Modal da Câmera
      captureImageBtn.addEventListener("click", captureAndIdentify);

      modalAddButton.addEventListener("click", () => {
        const product = identifiedProductNameInput.value.trim();
        const unitPrice = modalUnitPriceInput.value.trim();
        const quantity = modalQuantityInput.value.trim();

        if (!product || !unitPrice || !quantity) {
          showMessage("Por favor, preencha todos os campos do modal.", "error");
          return;
        }

        addNewRow(product, unitPrice, quantity);
        cameraModal.classList.add('hidden');
        showMessage("Produto adicionado com sucesso!", "success");
      });

      modalCancelButton.addEventListener("click", () => {
        cameraModal.classList.add('hidden');
        stopCamera();
      });

      // Event Listeners dos Modais de API Key
      modalContinueButton.addEventListener('click', () => {
        geminiApiKey = modalApiKeyInput.value.trim();
        apiKeyModal.classList.add('hidden');
        if (geminiApiKey) {
          const promptText = geminiPromptInput.value.trim();
          if (promptText) {
            callGeminiApi(promptText);
          }
        } else {
          showMessage("API Key inválida.", 'error');
        }
      });

      modalCancelApiButton.addEventListener('click', () => {
        apiKeyModal.classList.add('hidden');
        showMessage("Funcionalidade de IA ignorada.", 'info');
      });

      instructionsButton.addEventListener("click", () => {
        instructionsModal.classList.remove("hidden");
      });

      closeInstructions.addEventListener("click", () => {
        instructionsModal.classList.add("hidden");
      });
      
      // ----------------------------------------------------------------------------------
      // Navegação e Lógica de Segurança
      // ----------------------------------------------------------------------------------

      // Gerencia qual página está visível
      function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
      }

      // Event listeners para os botões de navegação
      navCalculator.addEventListener('click', () => showPage('calculator-page'));
      navShoppingList.addEventListener('click', () => showPage('shopping-list-page'));
      navLogs.addEventListener('click', () => {
        showPage('logs-page');
      });

      // Lógica de segurança: para a câmera quando a página não está ativa
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && isCameraActive) {
          stopCamera();
          // Não mostra mensagem, pois o modal estará fechado
        }
      });
      
      // ----------------------------------------------------------------------------------
      // Inicialização
      // ----------------------------------------------------------------------------------
      showPage('calculator-page');
      loadDataFromCalculatorLocalStorage();
      loadDataFromShoppingListLocalStorage();
    });
  </script>
</body>
</html>
